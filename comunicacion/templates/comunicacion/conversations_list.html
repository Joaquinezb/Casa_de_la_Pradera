{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/comunicacion/comunicacion.css' %}">
{% endblock %}
{% block content %}
<div style="margin-bottom: 24px;">
    <h2 style="margin-bottom: 8px;">Comunicación</h2>
    <p style="color: var(--color-muted);">Gestiona conversaciones, solicitudes e incidentes</p>
    <a href="{% url 'comunicacion:archived_list' %}" class="btn btn--ghost" style="margin-top: 8px;">Ver conversaciones archivadas</a>
</div>

<div class="card">
    <div class="card-title">Conversaciones Activas</div>
    {% if conversations %}
        {% for c in conversations %}
        <div class="conversation-item">
            <div>
                <div class="conversation-title">
                    {% if c.is_group and c.cuadrilla %}
                        Grupo: {{ c.cuadrilla.nombre }}
                    {% else %}
                        {% if c.nombre %}
                            {{ c.nombre }}
                        {% else %}
                            {% for p in c.participants.all %}
                                {{ p.get_full_name|default:p.username }}{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                Conversación privada
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                </div>
                <div class="conversation-meta">
                    {% if c.is_group %}Grupo{% else %}Privada{% endif %}
                </div>
            </div>
            <a href="{% url 'comunicacion:conversation_detail' c.pk %}" class="btn btn--ghost">Abrir</a>
        </div>
        {% endfor %}
    {% else %}
        <p style="color: var(--color-muted);">No tienes conversaciones activas.</p>
    {% endif %}
</div>

{% if not is_jefe %}
<hr class="section-divider">
<div class="card">
    <div class="card-title">Mi(s) Cuadrilla(s)</div>
    {% if mis_cuadrillas %}
        {% for item in mis_cuadrillas %}
            <h4 style="margin-top: 16px; margin-bottom: 12px;">{{ item.cuadrilla.nombre }}</h4>
            <ul class="member-list">
                {% for m in item.miembros %}
                <li class="member-item">
                    {% with user=m.user %}
                        <div>
                            <strong>{{ user.get_full_name|default:user.username }}</strong>
                            {% if m.rol %}<span style="color: var(--color-muted); margin-left: 8px;">{{ m.rol }}</span>{% endif %}
                        </div>
                        <a href="{% url 'comunicacion:crear_privada' user.pk %}" class="btn btn--ghost" style="padding: 4px 10px; font-size: 13px;">Enviar mensaje</a>
                    {% endwith %}
                </li>
                {% empty %}
                <li class="member-item" style="color: var(--color-muted);">No hay otros miembros en esta cuadrilla.</li>
                {% endfor %}
            </ul>
        {% endfor %}
    {% else %}
        <p style="color: var(--color-muted);">No perteneces a ninguna cuadrilla todavía.</p>
    {% endif %}
</div>
{% endif %}

{% if not is_jefe and mis_cuadrillas and not is_lider %}
<hr class="section-divider">
<div class="card">
    <div class="card-title">Hablar con mi Líder</div>
    <ul class="member-list">
        {% for item in mis_cuadrillas %}
            {% if item.cuadrilla.lider %}
            <li class="member-item">
                <strong>{{ item.cuadrilla.lider.get_full_name|default:item.cuadrilla.lider.username }}</strong>
                <span style="color: var(--color-muted); margin-left: 8px;">Líder de {{ item.cuadrilla.nombre }}</span>
                <a href="{% url 'comunicacion:crear_privada' item.cuadrilla.lider.pk %}" class="btn btn--ghost" style="padding: 4px 10px; font-size: 13px; margin-left: 12px;">Enviar mensaje</a>
            </li>
            {% endif %}
        {% empty %}
            <li class="member-item" style="color: var(--color-muted);">No se encontró líder de tus cuadrillas.</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if lideres_proyecto %}
<hr class="section-divider">
<div class="card">
    <div class="card-title">Líderes de Cuadrillas de Tus Proyectos</div>
    <ul class="member-list">
        {% for lider in lideres_proyecto %}
        <li class="member-item">
            <strong>{{ lider.get_full_name|default:lider.username }}</strong>
            <a href="{% url 'comunicacion:crear_privada' lider.pk %}" class="btn btn--ghost" style="padding: 4px 10px; font-size: 13px;">Enviar mensaje</a>
        </li>
        {% empty %}
        <li class="member-item" style="color: var(--color-muted);">No hay líderes asignados a tus proyectos.</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<hr class="section-divider">

<div class="card">
    <div class="card-title">Acciones Rápidas</div>
    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px;">
        <a href="{% url 'comunicacion:enviar_solicitud' %}" class="btn btn--solicitud">Enviar Solicitud</a>
        <a href="{% url 'comunicacion:reportar_incidente' %}" class="btn btn--incidente">Reportar Incidente</a>
        {% if user.groups.all|join:", " == "LiderCuadrilla" or user.groups.all|join:", " == "JefeProyecto" %}
        <a href="{% url 'comunicacion:solicitudes_list' %}" class="btn btn--ghost">Ver Solicitudes</a>
        <a href="{% url 'comunicacion:incidentes_list' %}" class="btn btn--ghost">Ver Incidentes</a>
        {% endif %}
    </div>
</div>

{% endblock %}
{% extends 'base.html' %}
{% block content %}
<h2>Comunicación</h2>

<h3>Conversaciones</h3>
<ul>
    {% for c in conversations %}
    <li>
        <a href="{% url 'comunicacion:conversation_detail' c.pk %}">
            {% if c.is_group and c.cuadrilla %}
                Grupo: {{ c.cuadrilla.nombre }}
            {% else %}
                {# Mostrar el nombre explícito si existe, sino construir a partir de participantes #}
                {% if c.nombre %}
                    {{ c.nombre }}
                {% else %}
                    {% for p in c.participants.all %}
                        {{ p.get_full_name|default:p.username }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                        Conversación privada
                    {% endfor %}
                {% endif %}
            {% endif %}
        </a>
    </li>
    {% empty %}
    <li>No tienes conversaciones activas.</li>
    {% endfor %}
</ul>

<hr>
<h3>Mi(s) Cuadrilla(s)</h3>
{% if mis_cuadrillas %}
    {% for item in mis_cuadrillas %}
        <h4>{{ item.cuadrilla.nombre }}</h4>
        <ul>
            {% for m in item.miembros %}
            <li>
                {% with user=m.user %}
                    <strong>{{ user.get_full_name|default:user.username }}</strong>
                    {% if m.rol %} — <em>{{ m.rol }}</em>{% endif %}
                    - <a href="{% url 'comunicacion:crear_privada' user.pk %}">Enviar privado</a>
                {% endwith %}
            </li>
            {% empty %}
            <li>No hay otros miembros en esta cuadrilla.</li>
            {% endfor %}
        </ul>
    {% endfor %}
{% else %}
    <p>No perteneces a ninguna cuadrilla todavía.</p>
{% endif %}


<hr>

<h3>Acciones</h3>
<ul>
    <li><a href="{% url 'comunicacion:enviar_solicitud' %}">Enviar solicitud</a></li>
    <li><a href="{% url 'comunicacion:reportar_incidente' %}">Reportar incidente</a></li>
    {% if user.groups.all|join:", " == "LiderCuadrilla" or user.groups.all|join:", " == "JefeProyecto" %}
    <li><a href="{% url 'comunicacion:solicitudes_list' %}">Ver solicitudes de trabajadores</a></li>
    <li><a href="{% url 'comunicacion:incidentes_list' %}">Ver incidentes reportados</a></li>
    {% endif %}
</ul>

<hr>
<p><a href="/">Volver al inicio</a></p>
{% endblock %}
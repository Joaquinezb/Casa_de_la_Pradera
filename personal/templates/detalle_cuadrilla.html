{% extends 'base.html' %}
{% load custom_tags %}
{% block content %}

<h2>Detalle de Cuadrilla: {{ cuadrilla.nombre }}</h2>

<p><strong>Proyecto:</strong>
    {% if cuadrilla.proyecto %}
        {{ cuadrilla.proyecto.nombre }}
    {% else %}
        <em>Sin proyecto asignado</em>
    {% endif %}
</p>

<p><strong>Líder:</strong>
    {% if cuadrilla.lider %}
        {{ cuadrilla.lider.username }}
    {% else %}
        <em>Sin líder asignado</em>
    {% endif %}
</p>

<hr>

<h3>Trabajadores asignados</h3>

{% if trabajadores_detalle %}
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Trabajador</th>
            <th>Rol Operativo</th>
            <th>Disponibilidad</th>
            <th>Especialidad</th>
            <th>Competencias</th>
            <th>Certificaciones</th>
            <th>Experiencia</th>
            <th>Estado</th>
            <th>Ficha</th>
        </tr>
    </thead>
    <tbody>
    {% for t in trabajadores_detalle %}
        <tr>
            <td>{{ t.user.first_name }} {{ t.user.last_name }} ({{ t.user.username }})</td>
            <td>
                {% if t.rol %}
                    {{ t.rol.nombre }}
                {% else %}
                    Sin rol
                {% endif %}
            </td>
            <td>{{ t.disponibilidad }}</td>
            <td>{{ t.especialidad }}</td>
            <td>
                {% if comp_map|get_item:t.user.id %}
                    <ul>
                        {% for c in comp_map|get_item:t.user.id %}
                            <li>{{ c.nombre }} {% if c.certificada %}(Certificada){% endif %}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    —
                {% endif %}
            </td>
            <td>
                {% if cert_map|get_item:t.user.id %}
                    <ul>
                        {% for cert in cert_map|get_item:t.user.id %}
                            <li>{{ cert.nombre }}
                                {% if cert.archivo %}
                                    – <a href="{{ cert.archivo.url }}" target="_blank">PDF</a>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    —
                {% endif %}
            </td>
            <td>
                {% if exp_map|get_item:t.user.id %}
                    <ul>
                        {% for exp in exp_map|get_item:t.user.id %}
                            <li>
                                {% if exp.proyecto %}
                                    Proyecto interno: {{ exp.proyecto }}
                                {% else %}
                                    Externo: {{ exp.proyecto_externo }}{% if exp.empresa_externa %} ({{ exp.empresa_externa }}){% endif %}
                                {% endif %}
                                – {{ exp.calificacion }}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    —
                {% endif %}
            </td>
            <td>
                {% if t.user.trabajador_profile %}
                    <a href="{% url 'personal:editar_estado_trabajador' t.user.trabajador_profile.id %}"
                       class="btn btn-sm btn-warning">Estado</a>
                {% else %}
                    <em>Sin perfil</em>
                {% endif %}
            </td>
            <td>
                {% if t.user.trabajador_profile %}
                    <a href="{% url 'personal:detalle_trabajador' t.user.trabajador_profile.id %}"
                       class="btn btn-sm btn-info">Ficha</a>
                {% else %}
                    <em>Sin ficha</em>
                {% endif %}
            </td>
            {% if can_manage %}
            <td>
                <form method="post" action="{% url 'personal:mover_trabajador' %}">
                    {% csrf_token %}
                    <input type="hidden" name="asignacion_id" value="{{ t.asignacion.id }}">
                    <select name="nueva_cuadrilla_id" class="form-select form-select-sm">
                        {% for c in cuadrillas %}
                            {% if c.id != cuadrilla.id %}
                                <option value="{{ c.id }}">{{ c.nombre }}{% if c.proyecto %} ({{ c.proyecto.nombre }}){% endif %}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-outline-primary mt-1">Mover</button>
                </form>
            </td>
            <td>
                <form method="post" action="{% url 'personal:quitar_trabajador' %}">
                    {% csrf_token %}
                    <input type="hidden" name="asignacion_id" value="{{ t.asignacion.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger mt-1" onclick="return confirm('¿Seguro que quieres quitar este trabajador de la cuadrilla?')">Quitar</button>
                </form>
            </td>
            {% endif %}
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>No hay trabajadores asignados.</p>
{% endif %}

<a href="{% url 'proyectos:panel' %}" class="btn btn-secondary mt-3">Volver</a>
<a href="{% url 'personal:editar_cuadrilla' cuadrilla.id %}" class="btn btn-primary mt-3 ms-2">Editar</a>

{% if can_manage and not cuadrilla.proyecto %}
    <form method="post" action="{% url 'personal:disolver_cuadrilla' cuadrilla.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger mt-3 ms-2" onclick="return confirm('¿Seguro que quieres disolver esta cuadrilla? Esta acción eliminará la cuadrilla y sus asignaciones.')">Disolver Cuadrilla</button>
    </form>
{% endif %}

{% endblock %}

{% extends 'base.html' %}
{% block content %}

<h2>Crear Cuadrilla</h2>

<form method="post">
    {% csrf_token %}

    <div class="mb-3">
        <label>Nombre de la cuadrilla:</label><br>
        <input type="text" name="nombre" required>
    </div>

    <div class="mb-3">
        <label>Proyecto asociado:</label><br>
        <select name="proyecto" required>
            <option value="">-- Selecciona un proyecto --</option>
            {% for p in proyectos %}
                <option value="{{ p.id }}">{{ p.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label>LÃ­der (opcional):</label><br>
        <select name="lider">
            <option value="">-- Ninguno --</option>
            {% for t in trabajadores %}
                {% if t.user %}
                    <option value="{{ t.user.id }}">
                        {{ t.nombre }} {{ t.apellido }}
                    </option>
                {% endif %}
            {% endfor %}
        </select>
    </div>

    <h4>Seleccionar trabajadores y roles</h4>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Seleccionar</th>
                <th>Trabajador</th>
                <th>Rol</th>
            </tr>
        </thead>

        <tbody>
            {% for t in trabajadores %}
                <tr>
                    <td>
                        <input class="trabajador-checkbox"
                               type="checkbox"
                               name="trabajadores"
                               value="{{ t.id }}">
                    </td>

                    <td>{{ t.nombre }} {{ t.apellido }} ({{ t.rut }})</td>

                    <td>
                        <select name="roles_{{ t.id }}">
                            <option value="">-- Rol --</option>
                            {% for r in roles %}
                                <option value="{{ r.id }}">{{ r.nombre }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="submit" class="btn btn-primary mt-2">Guardar Cuadrilla</button>
    <a href="{% url 'proyectos:panel' %}" class="btn btn-secondary mt-2">Cancelar</a>
</form>

<script>
(function(){
    function toggleRoleSelect(id){
        var chk = document.querySelector('input.trabajador-checkbox[value="'+id+'"]');
        var sel = document.querySelector('select[name="roles_'+id+'"]');
        if(!sel || !chk) return;
        sel.disabled = !chk.checked;
    }

    function init(){
        document.querySelectorAll('input.trabajador-checkbox').forEach(function(chk){
            var id = chk.value;
            chk.addEventListener('change', function(){ toggleRoleSelect(id); });
            toggleRoleSelect(id);
        });
    }

    if(document.readyState === 'loading')
        document.addEventListener('DOMContentLoaded', init);
    else
        init();
})();
</script>

{% endblock %}

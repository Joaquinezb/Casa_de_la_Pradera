{% extends 'base.html' %}
{% block content %}

<h2>Crear Cuadrilla</h2>

<form method="post">
    {% csrf_token %}
    {% if errors %}
        <div class="alert alert-danger">
            <ul>
                {% for e in errors %}
                    <li>{{ e }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <!-- ========================== -->
    <!-- DATOS DE CUADRILLA         -->
    <!-- ========================== -->

    <div class="mb-3">
        <label>Nombre de la cuadrilla:</label><br>
        <input type="text" name="nombre" required>
    </div>

    <div class="mb-3">
        <label>Proyecto asociado:</label><br>
        <select name="proyecto" required>
            <option value="">-- Selecciona un proyecto --</option>
            {% for p in proyectos %}
                <option value="{{ p.id }}">{{ p.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label>Líder (opcional):</label><br>
        <select name="lider">
            <option value="">-- Ninguno --</option>
            {% for item in posibles_lideres %}
                {% with u=item.user %}
                    {% if item.selectable %}
                        <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }}{% if not u.first_name and not u.last_name %} ({{ u.username }}){% endif %}</option>
                    {% else %}
                        <option value="{{ u.id }}" disabled>{{ u.first_name }} {{ u.last_name }}{% if not u.first_name and not u.last_name %} ({{ u.username }}){% endif %} (ocupado)</option>
                    {% endif %}
                {% endwith %}
            {% empty %}
                <!-- No hay líderes configurados -->
            {% endfor %}
        </select>
    </div>

    <hr>

    <!-- ========================== -->
    <!--  FILTROS AVANZADOS        -->
    <!-- ========================== -->

    <h4>Filtrar personal</h4>

    <div class="row mb-3">

        <div class="col-md-3">
            <label>Buscar por nombre:</label>
            <input id="filtro-nombre" class="form-control" placeholder="Ej: Juan Pérez">
        </div>

        <div class="col-md-3">
            <label>Especialidad:</label>
            <select id="filtro-especialidad" class="form-control">
                <option value="todas">Todas</option>
                {% for esp in especialidades %}
                    <option value="{{ esp|lower }}">{{ esp }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label>Disponibilidad:</label>
            <select id="filtro-disponibilidad" class="form-control">
                <option value="todas">Todas</option>
                <option value="disponible">Disponible</option>
                <option value="ocupado">Ocupado</option>
                <option value="vacaciones">Vacaciones</option>
                <option value="licencia">Licencia</option>
                <option value="inactivo">Inactivo</option>
                <option value="no_disponible">No disponible</option>
            </select>
        </div>

        <div class="col-md-3">
            <label>Certificaciones:</label>
            <select id="filtro-certificacion" class="form-control">
                <option value="todas">Todas</option>
                <option value="tiene">Con certificaciones</option>
                <option value="sin">Sin certificaciones</option>
            </select>
        </div>

    </div>

    <hr>

    <!-- ========================== -->
    <!-- TABLA DE TRABAJADORES      -->
    <!-- ========================== -->

    <h4>Seleccionar trabajadores y roles</h4>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Sel.</th>
                <th>Trabajador</th>
                <th>Disponibilidad</th>
                <th>Certificaciones</th>
                <th>Rol</th>
                <th>Ficha</th>
            </tr>
        </thead>

        <tbody id="tabla-trabajadores">

        {% for t in trabajadores %}

            {% comment %} Considerar estados que impiden selección: 'licencia', 'vacaciones', 'no_disponible' {% endcomment %}
            <tr class="fila-trabajador {% if t.ocupado %}table-danger{% elif t.estado_real == 'licencia' or t.estado_real == 'vacaciones' %}table-warning{% endif %}"
            data-nombre="{{ t.nombre|lower }} {{ t.apellido|lower }}"
            data-especialidad="{{ t.especialidad|default:'ninguna'|lower }}"
            data-disponibilidad="{% if t.ocupado %}ocupado{% elif t.estado_real %}{{ t.estado_real|lower }}{% else %}no_disponible{% endif %}"
            data-certificaciones="{% if t.tiene_certificaciones %}tiene{% else %}sin{% endif %}"
            data-cert-list="{{ t.certificacion_lista|join:',' }}">

            <!-- Checkbox -->
            <td>
                {% if not t.user %}
                    <input type="checkbox" disabled>
                {% else %}
                    {% if t.ocupado or t.estado_real == 'licencia' or t.estado_real == 'vacaciones' or t.estado_real == 'no_disponible' %}
                        <input type="checkbox" disabled>
                    {% else %}
                        <input class="trabajador-checkbox"
                            type="checkbox"
                            name="trabajadores"
                            value="{{ t.user.id }}">
                    {% endif %}
                {% endif %}
            </td>

            <!-- Nombre -->
            <td>
                {{ t.nombre }} {{ t.apellido }}<br>
                <small class="text-muted">{{ t.rut }}</small>
            </td>

            <!-- Disponibilidad -->
            <td>
                {% if t.ocupado %}
                    <span class="badge bg-danger">Ocupado</span>
                {% elif t.estado_real == 'vacaciones' %}
                    <span class="badge bg-warning text-dark">Vacaciones</span>
                {% elif t.estado_real == 'licencia' %}
                    <span class="badge bg-warning text-dark">Licencia</span>
                {% elif t.estado_real == 'disponible' %}
                    <span class="badge bg-success">Disponible</span>
                {% elif t.estado_real %}
                    <span class="badge bg-success">{{ t.estado_real }}</span>
                {% else %}
                    <span class="badge bg-secondary">—</span>
                {% endif %}
            </td>

            <!-- Certificaciones -->
            <td>
                {% if t.tiene_certificaciones %}
                    <ul>
                        {% for c in t.certificacion_lista %}
                            <li>{{ c }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    —
                {% endif %}
            </td>

            <!-- Rol -->
            <td>
                    {% if t.ocupado or t.estado_real == 'licencia' or t.estado_real == 'vacaciones' or t.estado_real == 'no_disponible' %}
                        <select disabled class="form-control">
                            <option>—</option>
                        </select>
                        <input type="text" class="form-control mt-1" disabled placeholder="Nuevo rol (opcional)">
                    {% else %}
                        <select name="roles_{{ t.user.id }}" class="form-control rol-select">
                        <option value="">-- Rol --</option>
                        {% for r in roles %}
                            <option value="{{ r.id }}">{{ r.nombre }}</option>
                        {% endfor %}
                    </select>
                        <input type="text" name="roles_custom_{{ t.user.id }}" class="form-control mt-1" placeholder="Nuevo rol (opcional)">
                {% endif %}
            </td>

            <!-- Ficha -->
            <td>
                {% if t.user %}
                    <a href="{% url 'personal:detalle_trabajador' t.id %}"
                    class="btn btn-info btn-sm">Ver ficha</a>
                {% else %}
                    <em>Sin usuario</em>
                {% endif %}
            </td>

        </tr>

        {% endfor %}
        </tbody>

    </table>

    <button type="submit" class="btn btn-primary mt-2">Guardar Cuadrilla</button>
    <a href="{% url 'proyectos:panel' %}" class="btn btn-secondary mt-2">Cancelar</a>

</form>


<!-- ========================================================= -->
<!-- ======================= JAVASCRIPT ======================= -->
<!-- ========================================================= -->
<script>
(function(){

    // =========================================================
    // Filtro dinámico
    // =========================================================
    function filtrar(){
        let nombre = document.getElementById("filtro-nombre").value.toLowerCase();
        let esp = document.getElementById("filtro-especialidad").value;
        let disp = document.getElementById("filtro-disponibilidad").value;
        let cert = document.getElementById("filtro-certificacion").value;

        document.querySelectorAll(".fila-trabajador").forEach(function(row){

            let ok = true;

            let n = row.dataset.nombre.toLowerCase();
            let e = row.dataset.especialidad;
            let d = row.dataset.disponibilidad;
            let c = row.dataset.certificaciones;

            if(nombre && !n.includes(nombre)) ok = false;
            if(esp !== "todas" && e !== esp) ok = false;
            if(disp !== "todas" && d !== disp) ok = false;
            if(cert !== "todas" && c !== cert) ok = false;

            row.style.display = ok ? "" : "none";
        });
    }

    document.querySelectorAll("#filtro-nombre, #filtro-especialidad, #filtro-disponibilidad, #filtro-certificacion")
        .forEach(el => el.addEventListener("input", filtrar));

    // =========================================================
    // Habilitar/deshabilitar roles dependiendo del checkbox
    // =========================================================
    function toggleRoleSelect(id){
        let chk = document.querySelector('input.trabajador-checkbox[value="'+id+'"]');
        let sel = document.querySelector('select[name="roles_'+id+'"]');
        if(!chk || !sel) return;
        sel.disabled = !chk.checked;
    }

    function initRoleLogic(){
        document.querySelectorAll('input.trabajador-checkbox').forEach(chk=>{
            let id = chk.value;
            chk.addEventListener("change", ()=> toggleRoleSelect(id));
            toggleRoleSelect(id);
        });
    }

    document.addEventListener("DOMContentLoaded", initRoleLogic);

})();
</script>

{% endblock %}
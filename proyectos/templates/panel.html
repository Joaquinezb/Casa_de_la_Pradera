{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/proyectos/proyectos.css' %}">
{% endblock %}
{% block content %}
<style>
.btn-asignar-cuadrillas {
    height: 39px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>
<h2>Panel de Gestión de Proyectos</h2>

{% if is_jefe_view %}
<a href="{% url 'proyectos:nuevo' %}" class="btn btn-primary">+ Nuevo Proyecto</a>
{% endif %}

{% if is_jefe_view %}
<div class="alert alert-info mt-3">
    <strong>Vista Jefe:</strong> Todos los proyectos (lectura completa). Puedes crear proyectos ilimitados; editar solo tus propios proyectos.
</div>

<!-- Filtros para Jefe -->
<div class="row g-2 mb-3">
    <div class="col-md-4">
        <input id="filtro-buscar" class="form-control" placeholder="Buscar por proyecto o jefe...">
    </div>
    <div class="col-md-3">
        <select id="filtro-estado" class="form-select">
            <option value="todos">Mostrar: Todos</option>
            <option value="activos">Activos</option>
            <option value="finalizados">Finalizados</option>
        </select>
    </div>
    <div class="col-md-3">
        <select id="filtro-lider" class="form-select">
            <option value="">Filtrar por jefe (opcional)</option>
            <option value="mios">-- Míos --</option>
            {% for jefe in jefes_list %}
                <option value="{{ jefe.id }}">{{ jefe.nombre }}</option>
            {% endfor %}
        </select>
    </div>
</div>
{% endif %}

{% if is_lider_view %}
<div class="alert alert-warning mt-3">
    <strong>Vista Líder:</strong> Proyectos donde lideras cuadrilla(s). Puedes ver toda la información del proyecto y todas sus cuadrillas; editar solo tu(s) propia(s) cuadrilla(s) y gestionar trabajadores de tu cuadrilla.
</div>
{% endif %}

{% if data %}
{% for item in data %}
    <div class="card mt-4">
    <div class="card-body proyecto-card" data-nombre="{{ item.proyecto.nombre|lower }}" data-jefe="{{ item.proyecto.jefe.get_full_name|default:item.proyecto.jefe.username|lower }}" data-activo="true"
        {% if item.proyecto.jefe %}data-jefe-id="{{ item.proyecto.jefe.id }}"{% else %}data-jefe-id=""{% endif %}>
        <h4>
            {{ item.proyecto.nombre }}
            {% if item.can_edit_project %}
            <a href="{% url 'proyectos:editar' item.proyecto.id %}" class="btn btn-sm btn-outline-secondary ms-2 btn-icon-sm" title="Editar proyecto">
                &#9998;
            </a>
            {% endif %}
        </h4>
          <p><strong>Inicio:</strong> {{ item.proyecto.fecha_inicio }} |
              <strong>Término:</strong> {{ item.proyecto.fecha_termino|default:"—" }}</p>
          <p><strong>Jefe:</strong> {{ item.proyecto.jefe.get_full_name|default:item.proyecto.jefe.username }}{% if item.proyecto.created_by and item.proyecto.created_by.id != item.proyecto.jefe.id %} — <small>Creado por: {{ item.proyecto.created_by.get_full_name|default:item.proyecto.created_by.username }}</small>{% endif %}</p>
          <p class="small">Creado: {{ item.proyecto.created_at }}</p>
        <p><strong>Descripción:</strong> {{ item.proyecto.descripcion|default:"Sin descripción" }}</p>

        <h5 class="mt-3">Cuadrillas asignadas</h5>
        {% if item.cuadrillas %}
            <ul>
                {% for citem in item.cuadrillas %}
                    {% with c=citem.cuadrilla %}
                    <li>
                        <strong>{{ c.nombre }}</strong>
                        — Líder: {{ c.lider.username|default:"(Sin líder)" }}
                        — ({{ c.asignaciones.count }} trabajadores)

                        <a href="{% url 'personal:detalle_cuadrilla' c.id %}" class="btn btn-sm btn-outline-primary ms-2">
                            Ver cuadrilla
                        </a>
                        {% if citem.can_edit %}
                            <a href="{% url 'personal:editar_cuadrilla' c.id %}" class="btn btn-sm btn-outline-secondary ms-2">Editar cuadrilla</a>
                        {% endif %}
                    </li>
                    {% endwith %}
                {% endfor %}
            </ul>
        {% else %}
            <p>No hay cuadrillas asignadas.</p>
        {% endif %}

        {% if item.can_assign %}
          <a href="{% url 'proyectos:asignar_cuadrillas' item.proyecto.id %}"
              class="btn btn-sm btn-outline-primary mt-2 btn-asignar-cuadrillas">Asignar / Editar Cuadrillas</a>
        {% endif %}

        {% if is_lider_view %}
        <div class="mt-3" style="color: var(--color-muted); font-size: 13px;">
            Consejo: puedes editar solo tu(s) propia(s) cuadrilla(s). Si necesitas recursos o permisos, usa
            <a href="{% url 'comunicacion:enviar_solicitud' %}" class="btn btn--ghost" style="padding: 4px 10px; font-size: 13px; margin-left: 6px;">Enviar Solicitud</a>
            o abre
            <a href="{% url 'comunicacion:conversations_list' %}" class="btn btn--ghost" style="padding: 4px 10px; font-size: 13px; margin-left: 6px;">Conversaciones</a>.
        </div>
        {% endif %}

        {% if item.proyecto.activo %}
            {# Proyecto activo: solo mostrar botón si el usuario puede finalizarlo #}
            {% if item.can_finalize %}
                <a href="{% url 'proyectos:finalizar' item.proyecto.id %}" class="btn btn-sm btn-danger mt-2 ms-2">Finalizar proyecto</a>
            {% endif %}
        {% else %}
            {# Proyecto ya finalizado: mostrar badge #}
            <span class="badge bg-secondary ms-2">Finalizado</span>
        {% endif %}

        {% if item.can_create_cuadrilla %}
            <a href="{% url 'personal:crear_cuadrilla' %}" class="btn btn-outline-primary">+ Crear Cuadrilla</a>
        {% endif %}

    </div>
</div>
{% endfor %}
{% if is_jefe_view %}
<script>
(function(){
    function normalize(s){ return (s||'').toString().toLowerCase(); }

    function filtrar(){
        var elBuscar = document.getElementById('filtro-buscar');
        var elEstado = document.getElementById('filtro-estado');
        var elLider = document.getElementById('filtro-lider');

        const q = normalize(elBuscar && elBuscar.value);
        const estado = (elEstado && elEstado.value) || 'todos';
        const jefeVal = (elLider && elLider.value) || '';
        const jefeLower = normalize((elLider && elLider.selectedOptions && elLider.selectedOptions[0] && elLider.selectedOptions[0].text) || '');
        const currentUserId = String("{{ current_user_id }}");

        // Filtrar proyectos activos
        document.querySelectorAll('.proyecto-card').forEach(function(card){
            const nombre = normalize(card.dataset.nombre);
            const jname = normalize(card.dataset.jefe);
            const jId = String(card.dataset.jefeId || '');
            let show = true;
            if(q && !(nombre.includes(q) || jname.includes(q))) show = false;

            if(jefeVal){
                if(jefeVal === 'mios'){
                    if(jId !== currentUserId) show = false;
                } else {
                    if(jId !== jefeVal) show = false;
                }
            }

            if(estado === 'finalizados') show = false;
            card.parentElement.style.display = show ? '' : 'none';
        });

        // Filtrar proyectos finalizados
        document.querySelectorAll('.finalizado-item').forEach(function(el){
            const nombre = normalize(el.dataset.nombre);
            const jname = normalize(el.dataset.jefe);
            const jId = String(el.dataset.jefeId || '');
            let show = true;
            if(q && !(nombre.includes(q) || jname.includes(q))) show = false;

            if(jefeVal){
                if(jefeVal === 'mios'){
                    if(jId !== currentUserId) show = false;
                } else {
                    if(jId !== jefeVal) show = false;
                }
            }

            if(estado === 'activos') show = false;
            el.style.display = show ? '' : 'none';
        });
    }

    var elBuscar = document.getElementById('filtro-buscar');
    var elEstado = document.getElementById('filtro-estado');
    var elLider = document.getElementById('filtro-lider');
    if(elBuscar) elBuscar.addEventListener('input', filtrar);
    if(elEstado) elEstado.addEventListener('change', filtrar);
    if(elLider) elLider.addEventListener('change', filtrar);
})();
</script>
{% endif %}
{% else %}
<p class="mt-3">No tienes proyectos registrados aún.</p>
{% endif %}
    
    {% if cuadrillas_sin_proyecto and cuadrillas_sin_proyecto|length > 0 %}
    <div class="card mt-4">
        <div class="card-body">
            <h5>Cuadrillas sin proyecto</h5>
            <ul>
            {% load custom_tags %}
            {% for entry in cuadrillas_sin_proyecto %}
                {% with c=entry.cuadrilla %}
                <li class="mb-3">
                    <strong>{{ c.nombre }}</strong>
                    — Líder: {{ c.lider.username|default:"(Sin líder)" }}
                    — ({{ c.asignaciones.count }} trabajadores)
                    <a href="{% url 'personal:detalle_cuadrilla' c.id %}" class="btn btn-sm btn-outline-primary ms-2">Ver</a>
                    {% if entry.can_edit or request.user|has_group:'JefeProyecto' and not c.proyecto %}
                        <a href="{% url 'personal:editar_cuadrilla' c.id %}" class="btn btn-sm btn-outline-secondary ms-2">Editar</a>
                    {% else %}
                        <button class="btn btn-sm btn-outline-secondary ms-2" disabled title="No autorizado">Editar</button>
                    {% endif %}
                    {% if entry.can_disolver or request.user|has_group:'JefeProyecto' and not c.proyecto %}
                        <form method="post" action="{% url 'personal:disolver_cuadrilla' c.id %}" class="form-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger ms-2" onclick="return confirm('¿Deseas disolver la cuadrilla &quot;{{ c.nombre }}&quot;? Esta acción eliminará la cuadrilla y sus asignaciones.')">Disolver</button>
                        </form>
                    {% else %}
                        <button class="btn btn-sm btn-danger ms-2" disabled title="No autorizado">Disolver</button>
                    {% endif %}
                </li>
                {% endwith %}
            {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    {# Sección: Proyectos finalizados #}
    {% if finalizados and finalizados|length > 0 %}
    <div class="card mt-4">
        <div class="card-body">
            <h4>Proyectos finalizados</h4>
            {% for item in finalizados %}
                <div class="mb-3 finalizado-item" data-nombre="{{ item.proyecto.nombre|lower }}" data-jefe="{{ item.proyecto.jefe.get_full_name|default:item.proyecto.jefe.username|lower }}"
                    {% if item.proyecto.jefe %}data-jefe-id="{{ item.proyecto.jefe.id }}"{% else %}data-jefe-id=""{% endif %}>
                            <strong>{{ item.proyecto.nombre }}</strong>
                            – ({{ item.proyecto.fecha_inicio }} - {{ item.proyecto.fecha_termino|default:'—' }})
                            <span class="badge bg-secondary ms-2">Finalizado</span>
                            <p class="small">{{ item.proyecto.descripcion|default:'Sin descripción' }}</p>
                        </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endblock %}

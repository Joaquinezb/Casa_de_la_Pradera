{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <div class="container mt-4">
        <style>
        .btn-asignar-cuadrillas {
            width: 393.33px;
            height: 39px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        </style>
    <h2 style="margin-bottom: 8px;">Dashboard</h2>
    <p style="color: var(--color-muted);">Vista general del sistema</p>
</div>

<!-- Métricas principales (KPIs) -->
<div class="dashboard-metrics">
    <div class="card-kpi">
        <div class="heading">Proyectos Activos</div>
        <div class="number">{{ proyectos_activos }}</div>
    </div>
    <div class="card-kpi">
        <div class="heading">Proyectos Finalizados</div>
        <div class="number">{{ proyectos_finalizados }}</div>
    </div>
    <div class="card-kpi">
        <div class="heading">Cuadrillas Activas</div>
        <div class="number">{{ cuadrillas_activas }}</div>
    </div>
    <div class="card-kpi">
        <div class="heading">Trabajadores Disponibles</div>
        <div class="number">{{ trabajadores_disponibles }}/{{ total_trabajadores }}</div>
    </div>
</div>

<!-- Grid de información -->
<div class="grid grid--cols-2" style="margin-top: 24px;">
    <!-- Proyectos recientes -->
    <div class="card">
        <div class="card-title">Proyectos Recientes</div>
        {% if proyectos_recientes %}
        <ul style="list-style: none; padding: 0; margin: 0;">
            {% for proyecto in proyectos_recientes %}
            <li style="padding: 12px 0; border-bottom: 1px solid var(--color-border);">
                <strong>{{ proyecto.nombre }}</strong>
                <div style="font-size: 13px; color: var(--color-muted); margin-top: 4px;">
                    Jefe: {{ proyecto.jefe.get_full_name|default:proyecto.jefe.username }}
                    | Inicio: {{ proyecto.fecha_inicio }}
                </div>
                <div style="margin-top: 8px;">
                    <a href="{% url 'proyectos:panel' %}" class="btn btn--ghost" style="padding: 4px 10px; font-size: 13px;">Ver detalles</a>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="color: var(--color-muted);">No hay proyectos activos recientes.</p>
        {% endif %}
        
        {% if is_jefe %}
        <div style="margin-top: 16px;">
            <a href="{% url 'proyectos:nuevo' %}" class="btn btn--primary">+ Nuevo Proyecto</a>
        </div>
        {% endif %}
    </div>

    <!-- Cuadrillas sin asignar -->
    <div class="card">
        <div class="card-title">Cuadrillas Sin Proyecto</div>
        <div class="card-subtitle">{{ cuadrillas_sin_proyecto }} cuadrilla(s) disponible(s)</div>
        {% if cuadrillas_disponibles %}
        <ul style="list-style: none; padding: 0; margin: 0;">
            {% for cuadrilla in cuadrillas_disponibles %}
            <li style="padding: 12px 0; border-bottom: 1px solid var(--color-border);">
                <strong>{{ cuadrilla.nombre }}</strong>
                <div style="font-size: 13px; color: var(--color-muted); margin-top: 4px;">
                    Líder: {{ cuadrilla.lider.username|default:"Sin líder" }}
                    | Trabajadores: {{ cuadrilla.asignaciones.count }}
                </div>
                <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <a href="{% url 'personal:detalle_cuadrilla' cuadrilla.id %}" class="btn btn--ghost" style="padding: 4px 10px; font-size: 13px;">Ver cuadrilla</a>
                    {% if is_jefe %}
                    <button onclick="mostrarModalAsignar({{ cuadrilla.id }}, '{{ cuadrilla.nombre|escapejs }}')" class="btn btn--primary" style="padding: 4px 10px; font-size: 13px;">Asignar a Proyecto</button>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="color: var(--color-muted);">Todas las cuadrillas están asignadas a proyectos.</p>
        {% endif %}
        
        {% if is_jefe %}
        <div style="margin-top: 16px; display: flex; gap: 12px;">
            <a href="{% url 'personal:crear_cuadrilla' %}" class="btn btn--primary">+ Nueva Cuadrilla</a>
            {% if cuadrillas_sin_proyecto > 0 %}
            <a href="{% url 'core:asignar_cuadrillas_masivo' %}" class="btn btn--secondary">Asignar Múltiples Cuadrillas</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Accesos rápidos -->
<div class="card" style="margin-top: 24px;">
    <div class="card-title">Accesos Rápidos</div>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <a href="{% url 'proyectos:panel' %}" class="btn btn--ghost">Ver Todos los Proyectos</a>
        <a href="{% url 'comunicacion:conversations_list' %}" class="btn btn--ghost">Conversaciones</a>
        <a href="{% url 'personal:mis_notificaciones' %}" class="btn btn--ghost">Notificaciones</a>
        {% if is_jefe %}
        <a href="{% url 'proyectos:nuevo' %}" class="btn btn--primary">+ Nuevo Proyecto</a>
        <a href="{% url 'personal:crear_cuadrilla' %}" class="btn btn--primary">+ Nueva Cuadrilla</a>
        {% endif %}
    </div>
</div>

<!-- Modal para asignar cuadrilla a proyecto -->
{% if is_jefe %}
<div id="modalAsignarCuadrilla" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 style="margin-top: 0;">Asignar Cuadrilla a Proyecto</h3>
        <p id="nombreCuadrilla" style="color: var(--color-muted); margin-bottom: 16px;"></p>
        
        <form id="formAsignarCuadrilla" method="POST" action="">
            {% csrf_token %}
            <div style="margin-bottom: 16px;">
                <label for="proyecto_select" style="display: block; margin-bottom: 8px; font-weight: 500;">Seleccionar Proyecto:</label>
                <select id="proyecto_select" name="proyecto_id" required style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px;">
                    <option value="">-- Seleccione un proyecto --</option>
                    {% for proyecto in proyectos_activos_list %}
                    <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="cerrarModal()" class="btn btn--ghost">Cancelar</button>
                <button type="submit" class="btn btn--primary">Asignar</button>
            </div>
        </form>
    </div>
</div>

<script>
function mostrarModalAsignar(cuadrillaId, nombreCuadrilla) {
    document.getElementById('nombreCuadrilla').textContent = 'Cuadrilla: ' + nombreCuadrilla;
    document.getElementById('formAsignarCuadrilla').action = '/asignar-cuadrilla/' + cuadrillaId + '/';
    document.getElementById('modalAsignarCuadrilla').style.display = 'flex';
}

function cerrarModal() {
    document.getElementById('modalAsignarCuadrilla').style.display = 'none';
    document.getElementById('proyecto_select').value = '';
}

// Cerrar modal al hacer clic fuera
document.getElementById('modalAsignarCuadrilla')?.addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModal();
    }
});
</script>
{% endif %}

{% endblock %}
